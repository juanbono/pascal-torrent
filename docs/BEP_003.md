# BEP 3: The BitTorrent Protocol Specification

**BEP:** 3  
**Title:** The BitTorrent Protocol Specification  
**Version:** 0e08ddf84d8d3bf101cdf897fc312f2774588c9e  
**Last-Modified:** Sat Feb 4 12:58:40 2017 +0100  
**Author:** Bram Cohen <bram@bittorrent.com>  
**Status:** Final  
**Type:** Standard  
**Created:** 10-Jan-2008

---

## Abstract

BitTorrent is a protocol for distributing files. It identifies content by URL and is designed to integrate seamlessly with the web. Its advantage over plain HTTP is that when multiple downloads of the same file happen concurrently, the downloaders upload to each other, making it possible for the file source to support very large numbers of downloaders with only a modest increase in its load.

---

## A BitTorrent file distribution consists of these entities:

- An ordinary web server
- A static 'metainfo' file
- A BitTorrent tracker
- An 'original' downloader
- The end user web browsers
- The end user downloaders

There are ideally many end users for a single file.

---

## To start serving, a host goes through the following steps:

1. Start running a tracker (or, more likely, have one running already).
2. Start running an ordinary web server, such as apache, or have one already.
3. Associate the extension .torrent with mimetype application/x-bittorrent on their web server (or have done so already).
4. Generate a metainfo (.torrent) file using the complete file to be served and the URL of the tracker.
5. Put the metainfo file on the web server.
6. Link to the metainfo (.torrent) file from some other web page.
7. Start a downloader which already has the complete file (the 'origin').

---

## To start downloading, a user does the following:

1. Install BitTorrent (or have done so already).
2. Surf the web.
3. Click on a link to a .torrent file.
4. Select where to save the file locally, or select a partial download to resume.
5. Wait for download to complete.
6. Tell downloader to exit (it keeps uploading until this happens).

---

## Bencoding

Bencoding is the encoding used to store and transmit loosely structured data.

- **Strings** are length-prefixed base ten followed by a colon and the string. For example `4:spam` corresponds to 'spam'.
- **Integers** are represented by an 'i' followed by the number in base 10 followed by an 'e'. For example `i3e` corresponds to 3 and `i-3e` corresponds to -3. Integers have no size limitation. `i-0e` is invalid. All encodings with a leading zero, such as `i03e`, are invalid, other than `i0e`, which of course corresponds to 0.
- **Lists** are encoded as an 'l' followed by their elements (also bencoded) followed by an 'e'. For example `l4:spam4:eggse` corresponds to ['spam', 'eggs'].
- **Dictionaries** are encoded as a 'd' followed by a list of alternating keys and their corresponding values followed by an 'e'. For example, `d3:cow3:moo4:spam4:eggse` corresponds to {'cow': 'moo', 'spam': 'eggs'} and `d4:spaml1:a1:bee` corresponds to {'spam': ['a', 'b']}. Keys must be strings and appear in sorted order (sorted as raw strings, not alphanumerics).

---

## Metainfo File Structure

All data in a metainfo file is bencoded. The content of a metainfo file (the file ending in ".torrent") is a bencoded dictionary, containing the keys listed below.

### Common Keys

| Key | Type | Description |
|-----|------|-------------|
| `announce` | string | The URL of the tracker |
| `info` | dictionary | Maps to a dictionary whose keys depend on whether one or more files are being shared |

### Info Dictionary (Single File)

| Key | Type | Description |
|-----|------|-------------|
| `name` | string | The filename |
| `length` | integer | The length of the file in bytes |
| `md5sum` | string | (optional) 32-character hex string |
| `piece length` | integer | Number of bytes in each piece |
| `pieces` | string | Concatenation of all 20-byte SHA1 hash values |

### Info Dictionary (Multiple Files)

| Key | Type | Description |
|-----|------|-------------|
| `name` | string | The name of the directory |
| `files` | list | List of dictionaries containing `length`, `path`, and optional `md5sum` |
| `piece length` | integer | Number of bytes in each piece |
| `pieces` | string | Concatenation of all 20-byte SHA1 hash values |

---

## Trackers

Tracker GET requests have the following keys:

| Key | Description |
|-----|-------------|
| `info_hash` | 20-byte sha1 hash of the bencoded form of the info value |
| `peer_id` | 20-byte string used as id by this downloader |
| `ip` | Optional IP or DNS name of peer |
| `port` | Port number this peer is listening on |
| `uploaded` | Total amount uploaded so far (base ten ascii) |
| `downloaded` | Total amount downloaded so far (base ten ascii) |
| `left` | Number of bytes this peer still has to download |
| `event` | Optional: `started`, `completed`, `stopped` |

### Tracker Response

On success, the tracker returns a bencoded dictionary with:

| Key | Description |
|-----|-------------|
| `interval` | Seconds the downloader should wait between regular rerequests |
| `peers` | List of dictionaries with `peer id`, `ip`, and `port` |

---

## Peer Protocol

BitTorrent's peer protocol operates over TCP or uTP.

### Handshake

The handshake is a required message and must be the first message transmitted by the client.

```
handshake: <pstrlen><pstr><reserved><info_hash><peer_id>
```

- `pstrlen`: length of `pstr` as a single raw byte (19)
- `pstr`: protocol identifier: "BitTorrent protocol"
- `reserved`: eight reserved bytes (for extensions)
- `info_hash`: 20-byte SHA1 hash of info key
- `peer_id`: 20-byte string used as id

### Peer Connection State

Connections contain two bits of state on either end:
- **choked** or **not choked**
- **interested** or **not interested**

Connections start out **choked** and **not interested**.

### Message Types

All non-keepalive messages start with a single byte which gives their type:

| Value | Message | Description |
|-------|---------|-------------|
| 0 | choke | Choke the receiver |
| 1 | unchoke | Unchoke the receiver |
| 2 | interested | Express interest |
| 3 | not interested | Express lack of interest |
| 4 | have | Sender has piece index |
| 5 | bitfield | Bitfield of pieces sender has |
| 6 | request | Request block: `index`, `begin`, `length` |
| 7 | piece | Block payload: `index`, `begin`, `block` |
| 8 | cancel | Cancel request: `index`, `begin`, `length` |

---

## Algorithms

### Piece Selection

1. **Strict Priority**: Request all sub-pieces of a piece before any sub-pieces from other pieces
2. **Rarest First**: Download pieces that are least available first
3. **Random First Piece**: For new downloads, get a random piece first
4. **Endgame Mode**: When remaining pieces are all being downloaded, request from all peers

### Choking

Choking is done for several reasons:
- TCP congestion control works poorly when several connections simultaneously increase load
- Prevent free-riding

**Choking Algorithm**:
- Reciprocation: Unchoke peers that upload to us
- Optimistic unchoke: Unchoke one random peer regardless
- Rotate optimistic unchoke every 30 seconds

---

## References

- Original specification: https://www.bittorrent.org/beps/bep_0003.html
