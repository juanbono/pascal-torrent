# BEP 5: DHT Protocol

**BEP:** 5  
**Title:** DHT Protocol  
**Version:** aa944d9e2faf989cbb4b1bad5ec130b9f22631d9  
**Last-Modified:** Tue Jan 21 15:59:05 2020 -0800  
**Author:** Andrew Loewenstern <drue@bittorrent.com>, Arvid Norberg <arvid@bittorrent.com>  
**Status:** Accepted  
**Type:** Standards Track  
**Created:** 31-Jan-2008

---

## Abstract

BitTorrent uses a "distributed sloppy hash table" (DHT) for storing peer contact information for "trackerless" torrents. In effect, each peer becomes a tracker. The protocol is based on Kademlia and is implemented over UDP.

---

## Terminology

- **Peer**: A client/server listening on a TCP port that implements the BitTorrent protocol
- **Node**: A client/server listening on a UDP port implementing the DHT protocol
- **Node ID**: Each node has a globally unique identifier (160-bit)

---

## Distance Metric

In Kademlia, the distance metric is XOR and the result is interpreted as an unsigned integer:

```
distance(A, B) = |A xor B|
```

Smaller values are closer.

---

## Routing Table

Nodes maintain a routing table containing contact information for other nodes. The routing table:
- Covers the entire node ID space from 0 to 2^160
- Is subdivided into "buckets" that each cover a portion of the space
- Each bucket can hold K nodes (K = 8)
- When a bucket is full of known good nodes and our own ID falls in its range, it splits

### Node Classification

- **Good node**: Has responded to a query within the last 15 minutes OR has ever responded and sent a query within the last 15 minutes
- **Questionable node**: 15 minutes of inactivity
- **Bad node**: Fails to respond to multiple queries in a row

---

## KRPC Protocol

The KRPC protocol is a simple RPC mechanism consisting of bencoded dictionaries sent over UDP.

### Message Structure

Every message has three keys common to every message:

| Key | Description |
|-----|-------------|
| `t` | Transaction ID (string) |
| `y` | Message type: "q" (query), "r" (response), or "e" (error) |
| `v` | (optional) Client version string |

### Query Messages (`y` = "q")

Additional keys:
- `q`: Query method name (string)
- `a`: Arguments dictionary

### Response Messages (`y` = "r")

Additional key:
- `r`: Return values dictionary

### Error Messages (`y` = "e")

Additional key:
- `e`: List containing [error_code, error_message]

**Error Codes:**

| Code | Description |
|------|-------------|
| 201 | Generic Error |
| 202 | Server Error |
| 203 | Protocol Error |
| 204 | Method Unknown |

---

## Queries

All queries have an `id` key containing the querying node's ID.

### ping

Most basic query. Probes if a node is online.

**Query arguments:** `{ "id": "<querying nodes id>" }`

**Response:** `{ "id": "<queried nodes id>" }`

### find_node

Find contact information for a node given its ID.

**Query arguments:** `{ "id": "<querying nodes id>", "target": "<id of target node>" }`

**Response:** `{ "id": "<queried nodes id>", "nodes": "<compact node info>" }`

### get_peers

Get peers associated with a torrent infohash.

**Query arguments:** `{ "id": "<querying nodes id>", "info_hash": "<20-byte infohash>" }`

**Response with peers:**
```
{
    "id": "<queried nodes id>",
    "token": "<opaque write token>",
    "values": ["<peer 1 info string>", "<peer 2 info string>"]
}
```

**Response with closest nodes:**
```
{
    "id": "<queried nodes id>",
    "token": "<opaque write token>",
    "nodes": "<compact node info>"
}
```

### announce_peer

Announce that the peer is downloading a torrent on a port.

**Query arguments:**
```
{
    "id": "<querying nodes id>",
    "implied_port": <0 or 1>,
    "info_hash": "<20-byte infohash>",
    "port": <port number>,
    "token": "<opaque token>"
}
```

The `implied_port` argument, when present and non-zero, indicates that the source port of the UDP packet should be used instead of the port argument.

**Response:** `{ "id": "<queried nodes id>" }`

---

## Compact Node Info

Contact information for nodes is encoded as a 26-byte string:
- 20 bytes: Node ID (network byte order)
- 4 bytes: IPv4 address (network byte order)
- 2 bytes: Port (network byte order)

---

## Bootstrapping

New clients need bootstrap nodes to join the DHT. Common bootstrap nodes:
- `router.bittorrent.com:6881`
- `dht.transmissionbt.com:6881`

---

## References

- Specification: https://www.bittorrent.org/beps/bep_0005.html
- Kademlia paper: http://www.cs.rice.edu/Conferences/IPTPS02/109.pdf
