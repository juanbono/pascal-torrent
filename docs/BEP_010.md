# BEP 10: Extension Protocol

**BEP:** 10  
**Title:** Extension Protocol  
**Version:** 023256c7581a4bed356e47caf8632be2834211bd  
**Last-Modified:** Thu Jan 12 12:29:12 2017 -0800  
**Author:** Arvid Norberg <arvid@bittorrent.com>, Ludvig Strigeus <bittorrent@strigeus.com>, Greg Hazel <greg@bittorrent.com>  
**Status:** Accepted  
**Type:** Standards Track  
**Created:** 31-Jan-2008

---

## Abstract

The intention of this protocol is to provide a simple and thin transport for extensions to the bittorrent protocol. Supporting this protocol makes it easy to add new extensions without interfering with the standard bittorrent protocol or clients that don't support this extension.

---

## Extension Negotiation

### Reserved Bits

Bit 20 (counting from 0, right to left) of the reserved bytes in the handshake is used to indicate support for the extension protocol.

Check: `(reserved_byte[5] & 0x10) != 0`

### New Message Type

Once support is established, a new message type is supported:

| Name | ID |
|------|-----|
| extended | 20 |

### Message Format

```
<uint32_t length prefix>
<uint8_t bittorrent message ID> = 20
<uint8_t extended message ID>
<payload>
```

The extended message ID:
- `0` = Handshake message
- `>0` = Extended message as specified by handshake

---

## Handshake Message

The payload is a bencoded dictionary. All items are optional.

### Defined Dictionary Keys

| Key | Type | Description |
|-----|------|-------------|
| `m` | dictionary | Maps extension names to extended message IDs |
| `p` | integer | Local TCP listen port |
| `v` | string | Client name and version (UTF-8) |
| `yourip` | string | Compact IP address this peer sees you as |
| `ipv6` | string | Compact IPv6 address (16 bytes) |
| `ipv4` | string | Compact IPv4 address (4 bytes) |
| `reqq` | integer | Maximum outstanding request messages supported |

### Extension Naming

Extension names should be prefixed with a two-character client identifier to avoid collisions. Examples:
- `LT_metadata` - libtorrent metadata exchange
- `ut_pex` - µTorrent peer exchange
- `ut_metadata` - µTorrent metadata exchange

---

## Example Handshake

Dictionary:
```
{
    "m": {
        "LT_metadata": 1,
        "ut_pex": 2
    },
    "p": 6881,
    "v": "PascalTorrent 0.1.0"
}
```

Bencoded:
```
d1:md11:LT_metadatai1e6:ut_pexi2ee1:pi6881e1:v17:PascalTorrent 0.1.0e
```

---

## Runtime Extension Changes

The handshake message can be sent multiple times during the lifetime of a connection. The `m` dictionary is additive:
- New extensions can be added
- Setting an extension to `0` disables it

Example to disable LT_metadata:
```
d11:LT_metadatai0ee
```

---

## Design Rationale

1. **Single byte extended message ID**: Follows BitTorrent spec convention and saves bandwidth
2. **Dictionary for extensions**: Avoids global registry of message IDs
3. **Local IDs per peer**: Allows using constants and switch statements

---

## Common Extensions

### Metadata Exchange (BEP 9)

- Extension name: `ut_metadata`
- Allows downloading metadata from peers (for magnet links)

### Peer Exchange (PEX)

- Extension name: `ut_pex`
- Exchange peer lists without tracker

---

## References

- Specification: https://www.bittorrent.org/beps/bep_0010.html
